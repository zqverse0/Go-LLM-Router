<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Gateway Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // 在开发环境中抑制Tailwind CDN警告
        if (typeof window !== 'undefined') {
            const originalConsoleWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && args[0].includes && args[0].includes('should not be used in production')) {
                    return; // 忽略Tailwind CDN警告
                }
                return originalConsoleWarn.apply(console, args);
            };
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .modal-backdrop {
            backdrop-filter: blur(4px);
            background-color: rgba(0, 0, 0, 0.5);
        }
          .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 fade-in">
            <div class="px-6 py-4 border-b">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-shield-alt text-blue-600"></i>
                    Admin Authentication
                </h3>
            </div>
            <form id="loginForm" class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Admin API Key</label>
                    <input type="password" id="adminKeyInput" required
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                           placeholder="Enter your admin API key">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white rounded-lg py-2 hover:bg-blue-700 transition flex items-center justify-center gap-2">
                    <i class="fas fa-sign-in-alt"></i>
                    <span id="loginButtonText">Login</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
        <div class="container mx-auto px-6 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold flex items-center gap-3">
                        <i class="fas fa-rocket"></i>
                        LLM Gateway Admin Dashboard
                    </h1>
                    <p class="mt-2 text-blue-100">Manage your model groups and API keys</p>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="refreshDashboard()" id="refreshBtn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                    <button onclick="showIntegrationModal()" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-network-wired"></i>
                        Connect
                    </button>
                    <button onclick="showAdminKeysModal()" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-key"></i>
                        Admin Keys
                    </button>
                    <button onclick="showAddGroupModal()" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        Add Group
                    </button>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <i class="fas fa-layer-group text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-500">Total Groups</p>
                        <p class="text-2xl font-bold text-gray-800" id="totalGroups">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <i class="fas fa-server text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-500">Total Models</p>
                        <p class="text-2xl font-bold text-gray-800" id="totalModels">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-yellow-100 rounded-lg">
                        <i class="fas fa-key text-yellow-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-500">API Keys</p>
                        <p class="text-2xl font-bold text-gray-800" id="totalKeys">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-500">Total Requests</p>
                        <p class="text-2xl font-bold text-gray-800" id="totalRequests">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="loadingIndicator" class="hidden text-center py-12">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
            <p class="mt-4 text-gray-600">Loading data...</p>
        </div>

        <!-- Groups Container -->
        <div id="groupsContainer" class="space-y-6">
            <!-- Groups will be dynamically loaded here -->
        </div>
    </main>

    <!-- Add Group Modal -->
    <div id="addGroupModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 fade-in">
            <div class="px-6 py-4 border-b">
                <h3 class="text-xl font-bold">Add Model Group</h3>
            </div>
            <form id="addGroupForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Group ID</label>
                        <input type="text" name="group_id" required
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                               placeholder="e.g., ai-free-pool">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Strategy</label>
                        <select name="strategy" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="fallback">Fallback (Failover)</option>
                            <option value="round_robin">Round Robin</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('addGroupModal')" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Group</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Model Modal -->
    <div id="addModelModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 fade-in">
            <div class="px-6 py-4 border-b">
                <h3 class="text-xl font-bold">Add Model</h3>
            </div>
            <form id="addModelForm" class="p-6">
                <input type="hidden" id="addModelGroupId" name="group_id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Provider</label>
                        <select name="provider_name" required
                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="openai">OpenAI (Standard)</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="claude">Anthropic Claude</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upstream URL</label>
                        <input type="url" name="upstream_url" required
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                               placeholder="e.g., https://api.openai.com/v1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Model Name</label>
                        <input type="text" name="upstream_model" required
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                               placeholder="e.g., gpt-3.5-turbo">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Timeout (seconds)</label>
                        <input type="number" name="timeout" value="30" min="1" max="300"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">API Keys (one per line)</label>
                        <textarea name="keys" rows="3" required
                                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                  placeholder="sk-...
sk-..."></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('addModelModal')" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Model</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Key Modal -->
    <div id="addKeyModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 fade-in">
            <div class="px-6 py-4 border-b">
                <h3 class="text-xl font-bold">Add API Key</h3>
            </div>
            <form id="addKeyForm" class="p-6">
                <input type="hidden" id="addKeyModelId" name="model_id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                    <input type="password" name="key" required
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                           placeholder="sk-...">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal('addKeyModal')" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Key</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Keys Modal -->
    <div id="adminKeysModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl mx-4 fade-in">
            <div class="px-6 py-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-key text-yellow-600"></i>
                    Admin Keys Management
                </h3>
                <button onclick="closeModal('adminKeysModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-6 flex justify-between items-center">
                    <p class="text-gray-600">Manage your admin API keys for accessing the dashboard</p>
                    <button onclick="showAddAdminKeyModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        Generate New Key
                    </button>
                </div>

                <!-- Admin Keys Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Key Preview</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminKeysList" class="bg-white divide-y divide-gray-200">
                            <!-- Admin keys will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <div id="noAdminKeys" class="hidden text-center py-8 text-gray-500">
                    <i class="fas fa-key text-4xl mb-4"></i>
                    <p>No admin keys found.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Admin Key Modal -->
    <div id="addAdminKeyModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 fade-in">
            <div class="px-6 py-4 border-b">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-key text-green-600"></i>
                    Generate New Admin Key
                </h3>
            </div>
            <form id="addAdminKeyForm" class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Key Name</label>
                    <input type="text" name="name" required
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                           placeholder="e.g., MacBook Pro, Mobile Device">
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-blue-700">
                        <i class="fas fa-info-circle mr-2"></i>
                        A new admin key will be generated. Please save it securely as it will only be shown once.
                    </p>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal('addAdminKeyModal')"
                            class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-key"></i>
                        Create
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Admin Key Result Modal -->
    <div id="newAdminKeyModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 fade-in">
            <div class="px-6 py-4 border-b">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-check-circle text-green-600"></i>
                    Admin Key Generated Successfully
                </h3>
            </div>
            <div class="p-6">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <p class="text-sm text-yellow-700 mb-3 font-medium">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Please save this key now. It won't be shown again!
                    </p>
                    <div class="flex items-center gap-2">
                        <input type="text" id="newAdminKeyValue" readonly
                               class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-lg font-mono text-sm"
                               value="">
                        <button onclick="copyToClipboard(document.getElementById('newAdminKeyValue').value, this)"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg transition">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button onclick="closeModal('newAdminKeyModal'); loadAdminKeys();"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        I've Saved It
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Model Modal -->
    <div id="editModelModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 fade-in">
            <div class="px-6 py-4 border-b">
                <h3 class="text-xl font-bold">Edit Model</h3>
            </div>
            <form id="editModelForm" class="p-6">
                <input type="hidden" id="editModelId" name="id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Provider</label>
                        <select id="editProviderName" name="provider_name" required
                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="openai">OpenAI (Standard)</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="claude">Anthropic Claude</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upstream URL</label>
                        <input type="url" id="editUpstreamUrl" name="upstream_url" required
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                               placeholder="e.g., https://api.openai.com/v1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Model Name</label>
                        <input type="text" id="editUpstreamModel" name="upstream_model" required
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                               placeholder="e.g., gpt-3.5-turbo">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Timeout (seconds)</label>
                        <input type="number" id="editTimeout" name="timeout" min="1" max="300"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('editModelModal')" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 flex items-center gap-3 fade-in">
        <i id="toastIcon" class="fas fa-check-circle text-green-500 text-xl"></i>
        <span id="toastMessage">Success</span>
    </div>

    <!-- Integration Modal -->
    <div id="integrationModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl mx-4 fade-in">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-gradient-to-r from-purple-50 to-blue-50 rounded-t-lg">
                <h3 class="text-xl font-bold flex items-center gap-2 text-gray-800">
                    <i class="fas fa-network-wired text-purple-600"></i>
                    Client Integration Guide
                </h3>
                <button onclick="closeModal('integrationModal')" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-6 text-sm">
                    Your gateway now supports <strong>Universal Protocol Translation</strong>. You can connect any client to any model configured in this system.
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- OpenAI Card -->
                    <div class="border rounded-xl p-5 bg-white hover:shadow-md transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-green-100 rounded-bl-full -mr-8 -mt-8 z-0"></div>
                        <h4 class="font-bold text-green-700 mb-3 relative z-10 flex items-center gap-2">
                            <i class="fas fa-robot"></i> OpenAI Compatible
                        </h4>
                        
                        <div class="space-y-3 relative z-10">
                            <!-- Base URL -->
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[10px] text-gray-500 font-bold uppercase">Base URL (SDKs)</span>
                                    <button onclick="copyToClipboard(document.getElementById('baseOpenAIUrl').textContent, this)" class="text-gray-400 hover:text-green-600"><i class="far fa-copy"></i></button>
                                </div>
                                <div class="bg-gray-50 border border-gray-200 rounded p-2 text-[10px] font-mono text-gray-600 break-all" id="baseOpenAIUrl"></div>
                            </div>
                            
                            <!-- Full Endpoint -->
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[10px] text-gray-500 font-bold uppercase">Chat Endpoint (Direct)</span>
                                    <button onclick="copyToClipboard(document.getElementById('fullOpenAIUrl').textContent, this)" class="text-gray-400 hover:text-green-600"><i class="far fa-copy"></i></button>
                                </div>
                                <div class="bg-gray-900 border border-gray-700 rounded p-2 text-[10px] font-mono text-green-400 break-all shadow-inner" id="fullOpenAIUrl"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Claude Card -->
                    <div class="border rounded-xl p-5 bg-white hover:shadow-md transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-purple-100 rounded-bl-full -mr-8 -mt-8 z-0"></div>
                        <h4 class="font-bold text-purple-700 mb-3 relative z-10 flex items-center gap-2">
                            <i class="fas fa-sparkles"></i> Anthropic Claude
                        </h4>
                        
                        <div class="space-y-3 relative z-10">
                            <!-- Base URL -->
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[10px] text-gray-500 font-bold uppercase">Base URL (SDKs)</span>
                                    <button onclick="copyToClipboard(document.getElementById('baseClaudeUrl').textContent, this)" class="text-gray-400 hover:text-purple-600"><i class="far fa-copy"></i></button>
                                </div>
                                <div class="bg-gray-50 border border-gray-200 rounded p-2 text-[10px] font-mono text-gray-600 break-all" id="baseClaudeUrl"></div>
                            </div>
                            
                            <!-- Full Endpoint -->
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[10px] text-gray-500 font-bold uppercase">Messages Endpoint (Direct)</span>
                                    <button onclick="copyToClipboard(document.getElementById('fullClaudeUrl').textContent, this)" class="text-gray-400 hover:text-purple-600"><i class="far fa-copy"></i></button>
                                </div>
                                <div class="bg-gray-900 border border-gray-700 rounded p-2 text-[10px] font-mono text-purple-400 break-all shadow-inner" id="fullClaudeUrl"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Gemini Card -->
                    <div class="border rounded-xl p-5 bg-white hover:shadow-md transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-blue-100 rounded-bl-full -mr-8 -mt-8 z-0"></div>
                        <h4 class="font-bold text-blue-700 mb-3 relative z-10 flex items-center gap-2">
                            <i class="fas fa-gem"></i> Google Gemini
                        </h4>
                        
                        <div class="space-y-3 relative z-10">
                            <!-- Base URL -->
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[10px] text-gray-500 font-bold uppercase">Base URL</span>
                                    <button onclick="copyToClipboard(document.getElementById('baseGeminiUrl').textContent, this)" class="text-gray-400 hover:text-blue-600"><i class="far fa-copy"></i></button>
                                </div>
                                <div class="bg-gray-50 border border-gray-200 rounded p-2 text-[10px] font-mono text-gray-600 break-all" id="baseGeminiUrl"></div>
                            </div>
                            
                            <!-- Full Endpoint -->
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[10px] text-gray-500 font-bold uppercase">Endpoint Pattern</span>
                                    <button onclick="copyToClipboard(document.getElementById('fullGeminiUrl').textContent, this)" class="text-gray-400 hover:text-blue-600"><i class="far fa-copy"></i></button>
                                </div>
                                <div class="bg-gray-900 border border-gray-700 rounded p-2 text-[10px] font-mono text-blue-400 break-all shadow-inner" id="fullGeminiUrl"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-lightbulb text-yellow-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-800">
                                <strong>Pro Tip:</strong> You can use ANY API Key created in "Add Key" for ANY of these protocols. 
                                The gateway automatically routes requests based on the model name you provide, regardless of the client protocol used.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let adminKey = localStorage.getItem('admin_key');
        let dashboardData = [];

        // Modal 控制函数
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            }
        }

        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            if (adminKey) {
                document.getElementById('loginModal').classList.add('hidden');
                loadDashboard();
            } else {
                document.getElementById('loginModal').classList.remove('hidden');
            }

            // 【关键修复】实施件委托 - 替代直接事件绑定
            setupEventDelegation();

            // 静态表单事件保留（这些表单不会被重新创建）
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('addGroupForm').addEventListener('submit', handleAddGroup);
            document.getElementById('addModelForm').addEventListener('submit', handleAddModel);
            document.getElementById('addKeyForm').addEventListener('submit', handleAddKey);
            document.getElementById('editModelForm').addEventListener('submit', handleEditModel);
            document.getElementById('addAdminKeyForm').addEventListener('submit', createAdminKey);
        });

        // API helper function with debug logging
        async function fetchAPI(url, options = {}) {
            // 从 localStorage 获取最新的 admin key
            const token = localStorage.getItem('admin_key');

            // 1. 定义基础 Headers (使用Headers对象以避免编码问题)
            const headers = new Headers();
            headers.append('Content-Type', 'application/json');

            // 2. 强制注入 Auth Token (如果存在) - 添加防御性代码
            if (token && token.trim()) {
                const cleanToken = token.trim();

                // 检查token是否包含非ISO-8859-1字符
                try {
                    // 测试是否可以正常编码
                    encodeURIComponent(cleanToken);

                    // 进一步检查：确保只包含安全字符
                    if (!/^[a-zA-Z0-9\-_]+$/.test(cleanToken)) {
                        throw new Error('Token contains invalid characters');
                    }

                    headers.append('Authorization', 'Bearer ' + cleanToken);
                } catch (encodingError) {
                    // 如果编码失败，提供友好的错误提示
                    console.error('Token encoding error:', encodingError);
                    throw new Error('API key contains invalid characters. Only letters, numbers, hyphens, and underscores are allowed.');
                }
            }

            // 3. 构造请求选项
            const finalOptions = {
                method: options.method || 'GET',
                headers: headers,
            };

            // 4. 如果有body，添加body
            if (options.body) {
                finalOptions.body = options.body;
            }

            const response = await fetch(url, finalOptions);

            const data = await response.json();

            // 如果响应状态码不是 2xx，抛出错误包含后端返回的消息
            if (!response.ok) {
                const errorMessage = data?.error?.message || data?.message || "Request failed (" + response.status + ")";
                throw new Error(errorMessage);
            }

            return { response, data };
        }

        // 【关键修复】事件委托函数 - 使用 data 属性替代 onclick
        function setupEventDelegation() {
            // 委托给document（永远不会被替换的根元素）
            document.addEventListener('click', function(e) {
                // 查找点击的目标元素
                const target = e.target.closest('[data-action]');
                if (!target) return;

                e.preventDefault();
                const action = target.getAttribute('data-action');
                const id = target.getAttribute('data-id');
                const groupId = target.getAttribute('data-group-id');
                const key = target.getAttribute('data-key');

                switch (action) {
                    case 'showAddModelModal':
                        showAddModelModal(groupId);
                        break;
                    case 'deleteGroup':
                        deleteGroup(groupId);
                        break;
                    case 'editModel':
                        editModel(
                            id,
                            target.getAttribute('data-provider'),
                            target.getAttribute('data-url'),
                            target.getAttribute('data-model'),
                            parseInt(target.getAttribute('data-timeout'))
                        );
                        break;
                    case 'deleteModel':
                        deleteModel(id);
                        break;
                    case 'showAddKeyModal':
                        showAddKeyModal(id);
                        break;
                    case 'copyKey':
                        copyToClipboard(key, target);
                        break;
                    case 'deleteKey':
                        deleteKey(id);
                        break;
                    case 'copyAdminKey':
                        copyToClipboard(key, target);
                        break;
                    case 'deleteAdminKey':
                        deleteAdminKey(id);
                        break;
                }
            });
        }

        // Authentication functions
        async function handleLogin(e) {
            e.preventDefault();
            const key = document.getElementById('adminKeyInput').value.trim();
            const loginBtn = e.target.querySelector('button[type="submit"]');
            const loginText = document.getElementById('loginButtonText');

            if (!key) {
                showToast('Please enter an API key', 'error');
                return;
            }

            // 强制清洗输入：只允许字母、数字、连字符、下划线
            const cleanKey = key.replace(/[^a-zA-Z0-9\-_]/g, '');

            // 检查清洗后是否有效
            if (cleanKey.length < 10) {
                showToast('Invalid API key format. Only letters, numbers, hyphens, and underscores are allowed.', 'error');
                return;
            }

            // 如果清洗后的key与原key不同，说明有非法字符
            if (cleanKey !== key) {
                showToast('API key contains invalid characters and has been cleaned.', 'warning');
                document.getElementById('adminKeyInput').value = cleanKey; // 更新输入框显示
            }

            adminKey = cleanKey;
            localStorage.setItem('admin_key', cleanKey);

            loginBtn.disabled = true;
            loginText.innerHTML = '<span class="loading"></span> Authenticating...';

            try {
                const result = await fetchAPI('/admin/model-groups');

                if (result.response.ok) {
                    document.getElementById('loginModal').classList.add('hidden');
                    loadDashboard();
                } else {
                    console.error('Authentication failed:', result.data);
                    showToast(result?.data?.error?.message || 'Invalid API key', 'error');
                    // 清除无效的 key
                    localStorage.removeItem('admin_key');
                    adminKey = null;
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showToast(error.message || 'Authentication failed', 'error');
                // 清除无效的 key
                localStorage.removeItem('admin_key');
                adminKey = null;
            } finally {
                loginBtn.disabled = false;
                loginText.textContent = 'Login';
            }
        }

        function logout() {
            localStorage.removeItem('admin_key');
            adminKey = null;
            location.reload();
        }

        // Load dashboard data
        async function loadDashboard() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('refreshBtn').disabled = true;
            document.getElementById('refreshBtn').innerHTML = '<span class="loading"></span> Loading...';

            try {
                const result = await fetchAPI('/admin/model-groups');
                if (result && result.response.ok) {
                    dashboardData = result.data.data || [];
                    await loadDetailedData();
                    renderDashboard();
                    updateStats();
                } else {
                    showToast(result?.data?.error?.message || 'Failed to load data', 'error');
                }
            } catch (error) {
                console.error('Load dashboard error:', error);
                showToast(error.message || 'Failed to load dashboard data', 'error');

                // 如果是认证错误，显示登录框
                if (error.message.includes('API Key') || error.message.includes('认证')) {
                    document.getElementById('loginModal').classList.remove('hidden');
                }
            } finally {
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('refreshBtn').disabled = false;
                document.getElementById('refreshBtn').innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            }
        }

        // Load detailed data for each group
        async function loadDetailedData() {
            for (let group of dashboardData) {
                try {
                    // 【关键修改】使用 group_id 而不是 id，并添加 URL 编码
                    const result = await fetchAPI('/admin/model-groups/' + encodeURIComponent(group.group_id));
                    if (result && result.response.ok) {
                        group.details = result.data.data;
                    }
                } catch (error) {
                    console.error('Failed to load details for group', group.group_id, error);
                }
            }
        }

        // Render dashboard groups
        function renderDashboard() {
            const container = document.getElementById('groupsContainer');
            container.innerHTML = '';

            if (!dashboardData || dashboardData.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500">No model groups found. Click "Add Group" to create one.</div>';
                return;
            }

            dashboardData.forEach(function(group) {
                const groupCard = createGroupCard(group);
                container.appendChild(groupCard);
            });
        }

        // Create group card element
        function createGroupCard(group) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-lg';

            const strategyBadge = group.strategy === 'round_robin'
                ? '<span class="px-3 py-1 text-sm rounded-full bg-green-100 text-green-800"><i class="fas fa-circle text-xs mr-1"></i>Round Robin</span>'
                : '<span class="px-3 py-1 text-sm rounded-full bg-blue-100 text-blue-800"><i class="fas fa-circle text-xs mr-1"></i>Fallback</span>';

            // 【关键修改】使用可选链和正确的检查
            const modelsHtml = group.details?.models && group.details.models.length > 0
                ? group.details.models.map((model, index) => createModelRow(model, index, group.group_id)).join('')
                : '<div class="text-center py-4 text-gray-500">No models found</div>';

            card.innerHTML =
                '<div class="px-6 py-4 border-b border-gray-200">' +
                    '<div class="flex items-center justify-between">' +
                        '<div>' +
                            '<h2 class="text-xl font-bold text-gray-800">' + (group.group_id || 'Unknown') + '</h2>' +
                            '<div class="flex items-center gap-3 mt-2">' +
                                strategyBadge +
                                '<span class="text-sm text-gray-500">' + (group.model_count || 0) + ' models</span>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex items-center gap-2">' +
                            '<button data-action="showAddModelModal" data-group-id="' + (group.group_id || '') + '" class="text-blue-600 hover:text-blue-800 p-2" title="Add Model">' +
                                '<i class="fas fa-plus"></i>' +
                            '</button>' +
                            '<button data-action="deleteGroup" data-group-id="' + (group.group_id || '') + '" class="text-red-600 hover:text-red-800 p-2" title="Delete Group">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="p-6">' +
                    '<div class="space-y-4">' +
                        modelsHtml +
                    '</div>' +
                '</div>';

            return card;
        }

        // Create model row element
        function createModelRow(model, index, groupId) {
            // 修复：使用正确的字段名 api_keys 而不是 keys
            const keysHtml = model.api_keys && model.api_keys.length > 0
                ? model.api_keys.map(key => createKeyElement(key)).join('')
                : '<div class="text-sm text-gray-500">No API keys</div>';

            // 【关键修改】使用循环索引 + 1 作为路由索引
            const routingIndex = index + 1;

            // 修复：计算实际的 keys 数量而不是使用不存在的 keys_count
            const keysCount = model.api_keys ? model.api_keys.length : 0;

          // 确保ID作为字符串处理，避免精度丢失
            const modelIdStr = model.ID ? model.ID.toString() : '0';

            return '<div class="border rounded-lg p-4 hover:bg-gray-50 transition">' +
                '<div class="flex items-center justify-between mb-3">' +
                    '<div class="flex items-center gap-3">' +
                        '<span class="px-2 py-1 bg-gray-200 rounded text-sm font-mono">$' + routingIndex + '</span>' +
                        '<div>' +
                            '<div class="font-semibold text-gray-800">' + (model.provider_name || 'Unknown') + '</div>' +
                            '<div class="text-sm text-gray-600">' + (model.upstream_model || 'Unknown') + '</div>' +
                            '<div class="text-xs text-gray-500">' + (model.upstream_url || '') + '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="flex items-center gap-2">' +
                        '<button data-action="editModel" data-id="' + modelIdStr + '" data-provider="' + (model.provider_name || '').replace(/'/g, "\'") + '" data-url="' + (model.upstream_url || '').replace(/'/g, "\'") + '" data-model="' + (model.upstream_model || '').replace(/'/g, "\'") + '" data-timeout="' + (model.timeout || 30) + '" class="text-blue-600 hover:text-blue-800 p-2" title="Edit Model">' +
                            '<i class="fas fa-edit"></i>' +
                        '</button>' +
                        '<button data-action="deleteModel" data-id="' + modelIdStr + '" class="text-red-600 hover:text-red-800 p-2" title="Delete Model">' +
                            '<i class="fas fa-trash"></i>' +
                        '</button>' +
                    '</div>' +
                '</div>' +
                '<div class="mt-3">' +
                    '<div class="text-xs text-gray-500 mb-1">API Keys (' + keysCount + ')</div>' +
                    '<div class="flex flex-wrap gap-2">' +
                        keysHtml +
                        '<button data-action="showAddKeyModal" data-id="' + modelIdStr + '" class="px-2 py-1 bg-blue-100 text-blue-600 rounded text-xs hover:bg-blue-200" title="Add Key">' +
                            '<i class="fas fa-plus"></i>' +
                        '</button>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // API Key脱敏显示函数
        function maskApiKey(key) {
            if (!key || key.length <= 8) {
                return key;
            }
            return key.substring(0, 4) + '...' + key.substring(key.length - 4);
        }

        // Create key element with copy and delete buttons
        function createKeyElement(key) {
            const maskedKey = maskApiKey(key.key_value);
            const keyIdStr = key.ID ? key.ID.toString() : '0';
            return '<div class="relative group">' +
                '<span data-action="copyKey" data-key="' + (key.key_value || '') + '" class="px-2 py-1 bg-gray-100 rounded text-xs font-mono cursor-pointer hover:bg-gray-200 transition">' +
                    maskedKey +
                '</span>' +
                '<button data-action="deleteKey" data-id="' + keyIdStr + '" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs hidden group-hover:block" title="Delete Key">' +
                    '<i class="fas fa-times"></i>' +
                '</button>' +
            '</div>';
        }

        // Update statistics
        function updateStats() {
            let totalGroups = dashboardData ? dashboardData.length : 0;
            let totalModels = 0;
            let totalKeys = 0;
            let totalRequests = 0;

            if (dashboardData) {
                dashboardData.forEach(function(group) {
                    // 修复：使用正确的字段名 model_count
                    totalModels += group.model_count || 0;
                    if (group.details?.models) {
                        group.details.models.forEach(function(model) {
                            // 修复：使用正确的字段名
                            const keysCount = model.api_keys ? model.api_keys.length : 0;
                            totalKeys += keysCount;
                            totalRequests += model.total_requests || 0;
                        });
                    }
                });
            }

            document.getElementById('totalGroups').textContent = totalGroups;
            document.getElementById('totalModels').textContent = totalModels;
            document.getElementById('totalKeys').textContent = totalKeys;
            document.getElementById('totalRequests').textContent = totalRequests;
        }

        // Refresh dashboard
        function refreshDashboard() {
            loadDashboard();
        }

        // Modal functions
        function showIntegrationModal() {
            const origin = window.location.origin;
            
            // OpenAI
            document.getElementById('baseOpenAIUrl').textContent = origin + '/v1';
            document.getElementById('fullOpenAIUrl').textContent = origin + '/v1/chat/completions';
            
            // Claude
            document.getElementById('baseClaudeUrl').textContent = origin + '/v1';
            document.getElementById('fullClaudeUrl').textContent = origin + '/v1/messages';
            
            // Gemini
            document.getElementById('baseGeminiUrl').textContent = origin;
            document.getElementById('fullGeminiUrl').textContent = origin + '/v1beta/models/{model}:generateContent';
            
            showModal('integrationModal');
        }

        function showAddGroupModal() {
            showModal('addGroupModal');
        }

        function showAddModelModal(groupId) {
            // 添加 ID 验证保护
            if (!groupId || groupId === 'undefined' || groupId === 'null') {
                showToast('Invalid group ID', 'error');
                return;
            }
            document.getElementById('addModelGroupId').value = groupId;
            showModal('addModelModal');
        }

        function showAddKeyModal(modelId) {
            // 添加 ID 验证保护
            if (!modelId || modelId === 'undefined' || modelId === 'null') {
                showToast('Invalid model ID', 'error');
                return;
            }
            document.getElementById('addKeyModelId').value = modelId;
            showModal('addKeyModal');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';

                // 【关键修复】确保移除所有可能导致遮挡的类
                modal.classList.remove('flex', 'block');

                // Reset form if it exists
                const form = modal.querySelector('form');
                if (form) form.reset();
            }
        }

        // 【新增】强制关闭所有模态框的函数 - 解决模态框状态锁定问题
        function forceCloseAllModals() {
            const modals = document.querySelectorAll('[id$="Modal"]');
            modals.forEach(modal => {
                modal.classList.add('hidden');
                modal.classList.remove('flex', 'block');
                modal.style.display = 'none';
            });
        }

        // 【增强】showModal函数，确保模态框正确显示
        function showModal(modalId) {
            // 先强制关闭所有模态框，避免叠加
            forceCloseAllModals();

            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                modal.style.display = 'flex';
            }
        }

        // Form handlers
        async function handleAddGroup(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                group_id: formData.get('group_id'),
                strategy: formData.get('strategy')
            };

            try {
                await fetchAPI('/admin/model-groups', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                showToast('Group added successfully', 'success');
                closeModal('addGroupModal');
                loadDashboard();
            } catch (error) {
                showToast(error.message || 'Failed to add group', 'error');
            }
        }

        async function handleAddModel(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const keysText = formData.get('keys').trim();
            const keys = keysText.split('\n').filter(k => k.trim());

            const data = {
                provider_name: formData.get('provider_name'),
                upstream_url: formData.get('upstream_url'),
                upstream_model: formData.get('upstream_model'),
                timeout: parseInt(formData.get('timeout')),
                keys: keys
            };

            const groupId = formData.get('group_id');

            try {
                await fetchAPI('/admin/model-groups/' + groupId + '/models', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                showToast('Model added successfully', 'success');
                closeModal('addModelModal');
                loadDashboard();
            } catch (error) {
                showToast(error.message || 'Failed to add model', 'error');
            }
        }

        async function handleAddKey(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                key: formData.get('key')
            };

            const modelId = formData.get('model_id');
            try {
                await fetchAPI('/admin/models/' + modelId + '/keys', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                showToast('API key added successfully', 'success');
                closeModal('addKeyModal');
                loadDashboard();
            } catch (error) {
                showToast(error.message || 'Failed to add API key', 'error');
            }
        }

        // Edit Model functions
        function editModel(id, providerName, upstreamUrl, upstreamModel, timeout) {
            // 添加 ID 验证保护
            if (!id || id === 'undefined' || id === 'null') {
                showToast('Invalid model ID', 'error');
                return;
            }
            document.getElementById('editModelId').value = id;
            
            // Normalize provider name for dropdown
            let normalizedProvider = providerName ? providerName.toLowerCase() : 'openai';
            if (normalizedProvider === 'anthropic') normalizedProvider = 'claude';
            if (normalizedProvider === 'google') normalizedProvider = 'gemini';
            
            document.getElementById('editProviderName').value = normalizedProvider;
            document.getElementById('editUpstreamUrl').value = upstreamUrl;
            document.getElementById('editUpstreamModel').value = upstreamModel;
            document.getElementById('editTimeout').value = timeout;
            showModal('editModelModal');
        }

        async function handleEditModel(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const modelId = formData.get('id');

            const data = {
                provider_name: formData.get('provider_name'),
                upstream_url: formData.get('upstream_url'),
                upstream_model: formData.get('upstream_model'),
                timeout: parseInt(formData.get('timeout'))
            };

            try {
                await fetchAPI('/admin/models/' + modelId, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                showToast('Model updated successfully', 'success');
                closeModal('editModelModal');
                loadDashboard();
            } catch (error) {
                showToast(error.message || 'Failed to update model', 'error');
            }
        }

        // Delete functions
        async function deleteGroup(groupId) {
            // 添加 ID 验证保护
            if (!groupId || groupId === 'undefined' || groupId === 'null') {
                showToast('Invalid group ID', 'error');
                return;
            }
            if (!confirm('Are you sure you want to delete this group and all its models?')) return;

            try {
                await fetchAPI('/admin/model-groups/' + groupId, {
                    method: 'DELETE'
                });

                showToast('Group deleted successfully', 'success');
                loadDashboard();
            } catch (error) {
                showToast(error.message || 'Failed to delete group', 'error');
            }
        }

        async function deleteModel(modelId) {
            // 添加 ID 验证保护
            if (!modelId || modelId === 'undefined' || modelId === 'null') {
                showToast('Invalid model ID', 'error');
                return;
            }
            if (!confirm('Are you sure you want to delete this model?')) return;

            try {
                await fetchAPI('/admin/models/' + modelId, {
                    method: 'DELETE'
                });

                showToast('Model deleted successfully', 'success');
                loadDashboard();
            } catch (error) {
                showToast(error.message || 'Failed to delete model', 'error');
            }
        }

        async function deleteKey(keyId) {
            // 添加 ID 验证保护
            if (!keyId || keyId === 'undefined' || keyId === 'null') {
                showToast('Invalid key ID', 'error');
                return;
            }
            if (!confirm('Are you sure you want to delete this API key?')) return;

            try {
                await fetchAPI('/admin/keys/' + keyId, {
                    method: 'DELETE'
                });

                showToast('API key deleted successfully', 'success');
                loadDashboard();
            } catch (error) {
                showToast(error.message || 'Failed to delete API key', 'error');
            }
        }

        // Copy to clipboard (with fallback)
        function copyToClipboard(text, element) {
            // Try modern clipboard API first
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccess(element);
                }).catch(() => {
                    fallbackCopy(text, element);
                });
            } else {
                fallbackCopy(text, element);
            }
        }

        function fallbackCopy(text, element) {
            // Create temporary textarea
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-999999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();

            try {
                document.execCommand('copy');
                showCopySuccess(element);
            } catch (err) {
                showToast('Failed to copy', 'error');
            }

            document.body.removeChild(textarea);
        }

        // 【绝对稳】专门处理Admin Key复制的函数
        function handleCopyKey(button) {
            // 确保获取到按钮元素
            if (!button) {
                console.error('No button provided to handleCopyKey');
                showToast('Copy failed: invalid button', 'error');
                return;
            }

            // 多重尝试获取密钥
            let keyValue = null;

            // 方法1: 从data-full-key属性获取
            keyValue = button.getAttribute('data-full-key');

            // 方法2: 如果方法1失败，尝试从data-key属性获取
            if (!keyValue) {
                keyValue = button.getAttribute('data-key');
            }

            // 方法3: 如果都失败了，获取dataset
            if (!keyValue && button.dataset) {
                keyValue = button.dataset.fullKey || button.dataset.key;
            }

            // 详细调试信息
            console.log('handleCopyKey - button:', button);
            console.log('handleCopyKey - keyValue:', keyValue);
            console.log('handleCopyKey - keyValue length:', keyValue ? keyValue.length : 'null');
            console.log('handleCopyKey - keyValue contains "...":', keyValue ? keyValue.includes('...') : 'null');

            // 验证获取到的值
            if (!keyValue || keyValue === 'undefined' || keyValue === 'null' || keyValue.trim() === '') {
                console.error('No valid key found in button dataset', button);
                console.log('Available attributes:', Array.from(button.attributes).map(attr => attr.name + "='" + attr.value + "'"));
                showToast('Copy failed: no key available', 'error');
                return;
            }

            // 调用现有的复制函数
            copyToClipboard(keyValue.trim(), button);
        }

        function showCopySuccess(element) {
            const isIcon = element.tagName === 'I' || element.querySelector('i');

            if (isIcon) {
                // 处理图标按钮
                const icon = element.tagName === 'I' ? element : element.querySelector('i');
                const originalClass = icon.className;
                icon.className = 'fas fa-check text-green-600';
                setTimeout(() => {
                    icon.className = originalClass;
                }, 2000);
            } else {
                // 处理文本元素
                const originalText = element.textContent;
                element.textContent = 'Copied!';
                element.classList.add('text-green-600');
                setTimeout(() => {
                    element.textContent = originalText;
                    element.classList.remove('text-green-600');
                }, 2000);
            }
        }

        // Admin Keys Management
        function showAdminKeysModal() {
            loadAdminKeys(); // 先加载数据
            showModal('adminKeysModal'); // 再显示弹窗
        }

        async function loadAdminKeys() {
            try {
                const result = await fetchAPI('/admin/admin-keys');

                if (result && result.response.ok) {
                    const adminKeys = result.data.data;
                    const tableBody = document.getElementById('adminKeysList');
                    const noKeysMsg = document.getElementById('noAdminKeys');

                    if (adminKeys.length === 0) {
                        tableBody.innerHTML = '';
                        noKeysMsg.classList.remove('hidden');
                    } else {
                        noKeysMsg.classList.add('hidden');
                        // 【解除限制】Admin Key表格渲染 - 所有密钥都可完整复制
                        let rows = adminKeys.map((key, index) => {
                            // 显示用的脱敏密钥
                            const displayKey = key.key_preview || maskApiKey(key.key || 'No Key');
                            const keyIdStr = key.id ? key.id.toString() : '0';
                            const rowNumber = index + 1;

                            // 【关键修改】强制使用后端返回的完整密钥
                            const fullKey = key.key || 'No Key Available';
                            const buttonTitle = 'Copy Full Key';

                            console.log('Rendering Admin Key - ID:', key.id, 'Full Key Length:', fullKey.length);

                            // 安全地转义完整密钥用于HTML属性
                            const escapedFullKey = fullKey.replace(/"/g, '&quot;').replace(/'/g, '&#39;');

                            return '<tr>' +
                                '<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">' + rowNumber + '</td>' +
                                '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">' + key.name + '</td>' +
                                '<td class="px-6 py-4 whitespace-nowrap text-sm font-mono">' +
                                    '<span class="inline-block max-w-xs truncate" title="' + fullKey + '">' + displayKey + '</span>' +
                                '</td>' +
                                '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">' + new Date(key.created_at * 1000).toLocaleDateString() + '</td>' +
                                '<td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">' +
                                    '<button onclick="handleCopyKey(this)" data-full-key="' + escapedFullKey + '" class="text-blue-600 hover:text-blue-900 transition" title="' + buttonTitle + '">' +
                                        '<i class="fas fa-copy"></i>' +
                                    '</button>' +
                                    '<button data-action="deleteAdminKey" data-id="' + keyIdStr + '" class="text-red-600 hover:text-red-900 transition" title="Delete">' +
                                        '<i class="fas fa-trash"></i>' +
                                    '</button>' +
                                '</td>' +
                            '</tr>';
                        }).join('');
                        tableBody.innerHTML = rows;
                    }
                } else {
                    showToast(result?.data?.error?.message || 'Failed to load admin keys', 'error');
                }
            } catch (error) {
                showToast(error.message || 'Failed to load admin keys', 'error');
            }
        }

        function showAddAdminKeyModal() {
            showModal('addAdminKeyModal');
        }

        async function createAdminKey(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const name = formData.get('name');

            try {
                // 直接传 URL, Method, Body。不要传 Headers。
                const result = await fetchAPI('/admin/admin-keys', {
                    method: 'POST',
                    body: JSON.stringify({ name })
                });

                if (result && result.response.ok) {
                    const newKey = result.data.data;
                    document.getElementById('newAdminKeyValue').value = newKey.key;
                    closeModal('addAdminKeyModal');
                    showModal('newAdminKeyModal');
                    showToast('Admin key created successfully', 'success');
                } else {
                    showToast(result?.data?.message || result?.data?.error?.message || 'Failed to create admin key', 'error');
                }
            } catch (error) {
                showToast(error.message || 'Failed to create admin key', 'error');
            }
        }

        async function deleteAdminKey(keyId) {
            if (!confirm('Are you sure you want to delete this admin key? This action cannot be undone.')) return;

            try {
                const result = await fetchAPI('/admin/admin-keys/' + keyId, {
                    method: 'DELETE'
                });

                if (result && result.response.ok) {
                    showToast('Admin key deleted successfully', 'success');
                    loadAdminKeys();
                } else {
                    showToast(result?.data?.message || result?.data?.error?.message || 'Failed to delete admin key', 'error');
                }
            } catch (error) {
                showToast(error.message || 'Failed to delete admin key', 'error');
            }
        }

        // Toast notification
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');

            msg.textContent = message;
            icon.className = type === 'success'
                ? 'fas fa-check-circle text-green-500 text-xl'
                : 'fas fa-exclamation-circle text-red-500 text-xl';

            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // 【优化】移除自动轮询，改为手动刷新模式
        // 避免日志刷屏，提升用户体验
    </script>
</body>
</html>