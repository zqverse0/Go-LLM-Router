<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Gateway Admin</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                    keyframes: {
                        "accordion-down": {
                            from: { height: "0" },
                            to: { height: "var(--radix-accordion-content-height)" },
                        },
                        "accordion-up": {
                            from: { height: "var(--radix-accordion-content-height)" },
                            to: { height: "0" },
                        },
                    },
                    animation: {
                        "accordion-down": "accordion-down 0.2s ease-out",
                        "accordion-up": "accordion-up 0.2s ease-out",
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer base {
            :root {
                --background: 0 0% 100%;
                --foreground: 240 10% 3.9%;
                --card: 0 0% 100%;
                --card-foreground: 240 10% 3.9%;
                --popover: 0 0% 100%;
                --popover-foreground: 240 10% 3.9%;
                --primary: 240 5.9% 10%;
                --primary-foreground: 0 0% 98%;
                --secondary: 240 4.8% 95.9%;
                --secondary-foreground: 240 5.9% 10%;
                --muted: 240 4.8% 95.9%;
                --muted-foreground: 240 3.8% 46.1%;
                --accent: 240 4.8% 95.9%;
                --accent-foreground: 240 5.9% 10%;
                --destructive: 0 84.2% 60.2%;
                --destructive-foreground: 0 0% 98%;
                --border: 240 5.9% 90%;
                --input: 240 5.9% 90%;
                --ring: 240 5.9% 10%;
                --radius: 0.5rem;
            }
            body {
                @apply bg-background text-foreground font-sans antialiased selection:bg-primary/10 selection:text-primary;
            }
        }
        
        .animate-in {
            animation: animateIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes animateIn {
            from { opacity: 0; transform: scale(0.98) translateY(4px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            @apply bg-border rounded-full hover:bg-muted-foreground/50 transition-colors;
        }
    </style>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        function renderIcons() {
            if (window.lucide) {
                lucide.createIcons();
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Network Error Banner -->
    <div id="networkErrorBanner" class="hidden bg-destructive text-destructive-foreground px-4 py-2 text-center text-sm font-medium z-[100] sticky top-0">
        <div class="flex items-center justify-center gap-2">
            <i data-lucide="wifi-off" class="w-4 h-4"></i>
            <span data-i18n="connection_lost">Connection lost. Is the server running?</span>
            <button onclick="location.reload()" class="ml-2 underline hover:text-white/80" data-i18n="retry">Retry</button>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm hidden transition-all duration-200">
        <div class="bg-card text-card-foreground rounded-xl shadow-2xl w-full max-w-[400px] mx-4 animate-in border p-8">
            <div class="flex flex-col space-y-2 text-center mb-8">
                <div class="flex justify-center mb-4">
                    <div class="p-3 bg-primary text-primary-foreground rounded-xl shadow-lg">
                        <i data-lucide="shield-check" class="w-8 h-8"></i>
                    </div>
                </div>
                <h3 class="text-2xl font-bold tracking-tight" data-i18n="welcome_back">Welcome Back</h3>
                <p class="text-sm text-muted-foreground" data-i18n="enter_key">Enter your admin API key to access the gateway.</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div class="space-y-2">
                    <div class="relative">
                        <i data-lucide="key" class="absolute left-3 top-3 w-4 h-4 text-muted-foreground"></i>
                        <input type="password" id="adminKeyInput" required
                               class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 pl-9 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 transition-all font-mono"
                               placeholder="sk-...">
                    </div>
                </div>
                <button type="submit" class="inline-flex items-center justify-center w-full rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 shadow-sm">
                    <span id="loginButtonText" data-i18n="access_dashboard">Access Dashboard</span>
                </button>
            </form>
            <div class="mt-6 text-center">
                 <p class="text-xs text-muted-foreground" data-i18n="no_key_hint">Don't have a key? Check the server logs on startup.</p>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 sticky top-0 z-40">
        <div class="container mx-auto px-6 h-16 flex items-center justify-between max-w-7xl">
            <div class="flex items-center gap-2 font-bold text-lg tracking-tight">
                <div class="w-8 h-8 bg-primary text-primary-foreground rounded-lg flex items-center justify-center shadow-sm">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i>
                </div>
                <span class="hidden sm:inline-block" data-i18n="app_title">LLM Gateway</span>
            </div>
            
            <div class="flex items-center gap-2">
                 <button onclick="toggleLanguage()" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background hover:bg-accent hover:text-accent-foreground h-9 px-3 gap-2 text-muted-foreground hover:text-foreground">
                    <i data-lucide="languages" class="w-4 h-4"></i>
                    <span id="currentLang" class="hidden sm:inline">EN</span>
                </button>

                <div class="h-4 w-px bg-border mx-1"></div>

                <button onclick="refreshDashboard()" id="refreshBtn" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background hover:bg-accent hover:text-accent-foreground h-9 px-3 gap-2 text-muted-foreground hover:text-foreground">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    <span class="hidden sm:inline" data-i18n="refresh">Refresh</span>
                </button>
                
                 <button onclick="showLogsModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background hover:bg-accent hover:text-accent-foreground h-9 px-3 gap-2 text-muted-foreground hover:text-foreground">
                    <i data-lucide="scroll-text" class="w-4 h-4"></i>
                    <span class="hidden sm:inline" data-i18n="logs">Logs</span>
                </button>
                
                <button onclick="showIntegrationModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background hover:bg-accent hover:text-accent-foreground h-9 px-3 gap-2 text-muted-foreground hover:text-foreground">
                    <i data-lucide="cable" class="w-4 h-4"></i>
                    <span class="hidden sm:inline" data-i18n="connect">Connect</span>
                </button>
                
                <button onclick="showAdminKeysModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background hover:bg-accent hover:text-accent-foreground h-9 px-3 gap-2 text-muted-foreground hover:text-foreground">
                    <i data-lucide="key" class="w-4 h-4"></i>
                    <span class="hidden sm:inline" data-i18n="keys">Keys</span>
                </button>
                
                <button onclick="showAddGroupModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2 gap-2 ml-2 shadow-sm">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span class="hidden sm:inline" data-i18n="new_group">New Group</span>
                </button>
                
                <button onclick="logout()" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background hover:bg-destructive/10 hover:text-destructive h-9 w-9 ml-2" title="Logout">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 container mx-auto px-6 py-8 max-w-7xl">
        <!-- Stats Overview -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="rounded-xl border bg-card text-card-foreground shadow-sm hover:shadow-md transition-shadow">
                <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                    <h3 class="tracking-tight text-sm font-medium text-muted-foreground" data-i18n="total_groups">Total Groups</h3>
                    <i data-lucide="layers" class="w-4 h-4 text-muted-foreground/50"></i>
                </div>
                <div class="p-6 pt-0">
                    <div class="text-2xl font-bold tracking-tight" id="totalGroups">0</div>
                </div>
            </div>
            <div class="rounded-xl border bg-card text-card-foreground shadow-sm hover:shadow-md transition-shadow">
                <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                    <h3 class="tracking-tight text-sm font-medium text-muted-foreground" data-i18n="total_models">Total Models</h3>
                    <i data-lucide="box" class="w-4 h-4 text-muted-foreground/50"></i>
                </div>
                <div class="p-6 pt-0">
                    <div class="text-2xl font-bold tracking-tight" id="totalModels">0</div>
                </div>
            </div>
            <div class="rounded-xl border bg-card text-card-foreground shadow-sm hover:shadow-md transition-shadow">
                <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                    <h3 class="tracking-tight text-sm font-medium text-muted-foreground" data-i18n="active_keys">Active Keys</h3>
                    <i data-lucide="key" class="w-4 h-4 text-muted-foreground/50"></i>
                </div>
                <div class="p-6 pt-0">
                    <div class="text-2xl font-bold tracking-tight" id="totalKeys">0</div>
                </div>
            </div>
            <div class="rounded-xl border bg-card text-card-foreground shadow-sm hover:shadow-md transition-shadow">
                <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                    <h3 class="tracking-tight text-sm font-medium text-muted-foreground" data-i18n="total_requests">Total Requests</h3>
                    <i data-lucide="activity" class="w-4 h-4 text-muted-foreground/50"></i>
                </div>
                <div class="p-6 pt-0">
                    <div class="text-2xl font-bold tracking-tight" id="totalRequests">0</div>
                </div>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="loadingIndicator" class="hidden flex flex-col items-center justify-center py-16 text-muted-foreground">
            <div class="relative">
                <div class="h-8 w-8 rounded-full border-2 border-primary border-t-transparent animate-spin"></div>
            </div>
            <p class="mt-4 text-sm font-medium" data-i18n="syncing">Syncing data...</p>
        </div>

        <!-- Groups Container -->
        <div id="groupsContainer" class="space-y-6">
            <!-- Groups will be dynamically loaded here -->
        </div>
    </main>
    
    <footer class="border-t py-6 text-center text-sm text-muted-foreground">
        <p>LLM Gateway Dashboard &copy; 2025</p>
    </footer>

    <!-- Logs Modal -->
    <div id="logsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm hidden">
        <div class="bg-card text-card-foreground rounded-xl shadow-2xl w-full max-w-5xl mx-4 animate-in border flex flex-col h-[85vh]">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-muted/20">
                <div class="flex flex-col gap-0.5">
                    <h3 class="text-lg font-semibold tracking-tight flex items-center gap-2">
                        <i data-lucide="scroll-text" class="w-5 h-5 text-primary"></i>
                        <span data-i18n="logs_viewer">Logs Viewer</span>
                    </h3>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="refreshCurrentLogs()" class="inline-flex items-center justify-center rounded-md w-8 h-8 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                    <button onclick="closeModal('logsModal')" class="inline-flex items-center justify-center rounded-md w-8 h-8 text-sm font-medium transition-colors hover:bg-destructive hover:text-destructive-foreground">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b bg-muted/10 px-6">
                <button id="tabRequestLogs" onclick="switchLogTab('request')" class="px-4 py-3 text-sm font-medium border-b-2 border-primary text-primary transition-all">
                    <span data-i18n="request_history">Request History</span>
                </button>
                <button id="tabSystemLogs" onclick="switchLogTab('system')" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground transition-all">
                    <span data-i18n="system_console">System Console</span>
                </button>
            </div>

            <!-- Request Logs Content -->
            <div id="requestLogsContent" class="flex-1 overflow-auto flex flex-col">
                <div class="flex-1 overflow-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-muted/50 sticky top-0 z-10 backdrop-blur-sm border-b">
                            <tr>
                                <th class="px-4 py-3 text-left font-medium text-muted-foreground w-40" data-i18n="th_time">Time</th>
                                <th class="px-4 py-3 text-left font-medium text-muted-foreground w-20" data-i18n="th_status">Status</th>
                                <th class="px-4 py-3 text-left font-medium text-muted-foreground w-24" data-i18n="th_latency">Latency</th>
                                <th class="px-4 py-3 text-left font-medium text-muted-foreground" data-i18n="th_model">Model</th>
                                 <th class="px-4 py-3 text-left font-medium text-muted-foreground w-32" data-i18n="th_ip">IP</th>
                                 <th class="px-4 py-3 text-left font-medium text-muted-foreground w-20" data-i18n="th_reqid">ReqID</th>
                            </tr>
                        </thead>
                        <tbody id="logsList" class="divide-y divide-border"></tbody>
                    </table>
                    <div id="logsLoading" class="hidden py-12 text-center text-muted-foreground">
                        <i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>
                        <span data-i18n="loading_logs">Loading logs...</span>
                    </div>
                    <div id="logsEmpty" class="hidden py-12 text-center text-muted-foreground">
                        <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                        <span data-i18n="no_logs">No logs found.</span>
                    </div>
                </div>
                <div class="p-4 border-t bg-muted/20 flex justify-between items-center">
                    <span class="text-xs text-muted-foreground" id="logsPaginationInfo">Showing 0-0 of 0</span>
                    <div class="flex gap-2">
                        <button id="logsPrevBtn" onclick="prevLogs()" disabled class="px-3 py-1.5 rounded-md text-xs font-medium border bg-background hover:bg-accent disabled:opacity-50 transition-colors" data-i18n="prev">Previous</button>
                        <button id="logsNextBtn" onclick="nextLogs()" disabled class="px-3 py-1.5 rounded-md text-xs font-medium border bg-background hover:bg-accent disabled:opacity-50 transition-colors" data-i18n="next">Next</button>
                    </div>
                </div>
            </div>

            <!-- System Logs Content -->
            <div id="systemLogsContent" class="flex-1 overflow-hidden hidden flex flex-col">
                <div class="bg-zinc-950 text-zinc-300 p-4 font-mono text-[11px] leading-relaxed flex-1 overflow-auto" id="systemLogsTerminal">
                    <div class="text-zinc-500 italic" data-i18n="reading_file">Reading gateway.log...</div>
                </div>
                <div class="p-3 border-t bg-muted/20 flex justify-end">
                    <p class="text-[10px] text-muted-foreground uppercase tracking-widest font-bold">File: gateway.log</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Group Modal -->
    <div id="addGroupModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm hidden">
        <div class="bg-card text-card-foreground rounded-xl shadow-2xl w-full max-w-lg mx-4 animate-in border p-6">
            <div class="flex flex-col space-y-1.5 text-center sm:text-left mb-6">
                <h3 class="text-lg font-semibold leading-none tracking-tight" data-i18n="create_group">Create Model Group</h3>
                <p class="text-sm text-muted-foreground" data-i18n="group_desc">Groups allow you to load balance or failover between multiple models.</p>
            </div>
            <form id="addGroupForm" class="space-y-4">
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" data-i18n="group_id">Group ID</label>
                    <input type="text" name="group_id" required
                           class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                           placeholder="e.g., ai-free-pool">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" data-i18n="strategy">Strategy</label>
                    <select name="strategy" class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        <option value="fallback" data-i18n="fallback">Fallback (Failover)</option>
                        <option value="round_robin" data-i18n="round_robin">Round Robin</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal('addGroupModal')" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2" data-i18n="cancel">Cancel</button>
                    <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2" data-i18n="create">Create Group</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Model Modal -->
    <div id="addModelModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm hidden">
        <div class="bg-card text-card-foreground rounded-xl shadow-2xl w-full max-w-2xl mx-4 animate-in border p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex flex-col space-y-1.5 mb-6">
                <h3 class="text-lg font-semibold leading-none tracking-tight" data-i18n="add_model">Add Model</h3>
                <p class="text-sm text-muted-foreground" data-i18n="model_desc">Configure a new upstream model provider.</p>
            </div>
            <form id="addModelForm" class="space-y-4">
                <input type="hidden" id="addModelGroupId" name="group_id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none" data-i18n="provider">Provider</label>
                        <select name="provider_name" required
                                class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                            <option value="openai">OpenAI (Standard)</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="claude">Anthropic Claude</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none" data-i18n="timeout">Timeout (seconds)</label>
                        <input type="number" name="timeout" value="30" min="1" max="300"
                               class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none" data-i18n="upstream_url">Upstream URL</label>
                    <input type="url" name="upstream_url" required
                           class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                           placeholder="e.g., https://api.openai.com/v1">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none" data-i18n="model_name">Model Name</label>
                    <input type="text" name="upstream_model" required
                           class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                           placeholder="e.g., gpt-3.5-turbo">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none" data-i18n="api_keys">API Keys (one per line)</label>
                    <textarea name="keys" rows="4" required
                              class="flex w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 font-mono"
                              placeholder="sk-..."></textarea>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal('addModelModal')" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2" data-i18n="cancel">Cancel</button>
                    <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2" data-i18n="add">Add Model</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Key Modal -->
    <div id="addKeyModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm hidden">
        <div class="bg-card text-card-foreground rounded-xl shadow-2xl w-full max-w-md mx-4 animate-in border p-6">
            <div class="flex flex-col space-y-1.5 mb-6">
                <h3 class="text-lg font-semibold leading-none tracking-tight" data-i18n="add_key">Add API Key</h3>
            </div>
            <form id="addKeyForm" class="space-y-4">
                <input type="hidden" id="addKeyModelId" name="model_id">
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none" data-i18n="api_key">API Key</label>
                    <input type="password" name="key" required
                           class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 font-mono"
                           placeholder="sk-...">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal('addKeyModal')" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2" data-i18n="cancel">Cancel</button>
                    <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2" data-i18n="add">Add Key</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Keys Modal -->
    <div id="adminKeysModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm hidden">
        <div class="bg-card text-card-foreground rounded-xl shadow-2xl w-full max-w-4xl mx-4 animate-in border flex flex-col max-h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center">
                <div class="flex flex-col space-y-1">
                    <h3 class="text-lg font-semibold leading-none tracking-tight" data-i18n="admin_keys">Admin Keys</h3>
                    <p class="text-sm text-muted-foreground" data-i18n="admin_keys_desc">Manage access keys for this dashboard.</p>
                </div>
                <button onclick="closeModal('adminKeysModal')" class="rounded-md p-2 hover:bg-accent hover:text-accent-foreground">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="mb-4 flex justify-end">
                    <button onclick="showAddAdminKeyModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-green-600 text-white hover:bg-green-700 h-9 px-4 py-2 gap-2 shadow-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span data-i18n="generate_key">Generate New Key</span>
                    </button>
                </div>

                <div class="rounded-md border overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-muted/50">
                            <tr>
                                <th class="px-4 py-3 text-left font-medium text-muted-foreground">ID</th>
                                <th class="px-4 py-3 text-left font-medium text-muted-foreground" data-i18n="th_name">Name</th>
                                <th class="px-4 py-3 text-left font-medium text-muted-foreground" data-i18n="th_preview">Key Preview</th>
                                <th class="px-4 py-3 text-left font-medium text-muted-foreground" data-i18n="th_created">Created</th>
                                <th class="px-4 py-3 text-left font-medium text-muted-foreground w-[100px]" data-i18n="th_actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminKeysList" class="divide-y divide-border">
                            <!-- Admin keys loaded here -->
                        </tbody>
                    </table>
                </div>

                <div id="noAdminKeys" class="hidden text-center py-12 text-muted-foreground">
                    <i data-lucide="key" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
                    <p data-i18n="no_admin_keys">No admin keys found.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Admin Key Modal -->
    <div id="addAdminKeyModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm hidden">
        <div class="bg-card text-card-foreground rounded-xl shadow-2xl w-full max-w-md mx-4 animate-in border p-6">
            <div class="flex flex-col space-y-1.5 mb-6">
                <h3 class="text-lg font-semibold leading-none tracking-tight" data-i18n="new_admin_key">New Admin Key</h3>
            </div>
            <form id="addAdminKeyForm" class="space-y-4">
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none" data-i18n="key_name">Key Name</label>
                    <input type="text" name="name" required
                           class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                           placeholder="e.g., MacBook Pro">
                </div>
                <div class="rounded-md bg-blue-50/50 border border-blue-200 p-3">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i data-lucide="info" class="h-5 w-5 text-blue-500"></i>
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm text-blue-700" data-i18n="key_hint">The key will only be shown once. Please save it securely.</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal('addAdminKeyModal')" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2" data-i18n="cancel">Cancel</button>
                    <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2" data-i18n="create">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Admin Key Result Modal -->
    <div id="newAdminKeyModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm hidden">
        <div class="bg-card text-card-foreground rounded-xl shadow-2xl w-full max-w-lg mx-4 animate-in border p-6">
            <div class="flex flex-col space-y-1.5 mb-6">
                <div class="flex items-center gap-2 text-green-600 mb-2">
                    <i data-lucide="check-circle-2" class="w-6 h-6"></i>
                    <h3 class="text-lg font-semibold leading-none tracking-tight" data-i18n="key_generated">Key Generated</h3>
                </div>
            </div>
            <div class="space-y-4">
                <div class="rounded-md bg-amber-50/50 p-4 border border-amber-200">
                    <p class="text-sm text-amber-800 font-medium mb-2" data-i18n="save_key_msg">Please save this key now. It won't be shown again!</p>
                    <div class="flex items-center gap-2">
                        <input type="text" id="newAdminKeyValue" readonly
                               class="flex-1 h-9 rounded-md border border-amber-200 bg-white px-3 py-1 text-sm font-mono text-amber-900 focus:outline-none"
                               value="">
                        <button onclick="copyToClipboard(document.getElementById('newAdminKeyValue').value, this)"
                                class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-amber-100 text-amber-900 hover:bg-amber-200 h-9 px-3 shadow-sm">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <div class="flex justify-end pt-2">
                    <button onclick="closeModal('newAdminKeyModal'); loadAdminKeys();"
                            class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2" data-i18n="saved_it">
                        I've Saved It
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Model Modal -->
    <div id="editModelModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm hidden">
        <div class="bg-card text-card-foreground rounded-xl shadow-2xl w-full max-w-2xl mx-4 animate-in border p-6">
            <div class="flex flex-col space-y-1.5 mb-6">
                <h3 class="text-lg font-semibold leading-none tracking-tight" data-i18n="edit_model">Edit Model</h3>
            </div>
            <form id="editModelForm" class="space-y-4">
                <input type="hidden" id="editModelId" name="id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none" data-i18n="provider">Provider</label>
                        <select id="editProviderName" name="provider_name" required
                                class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                            <option value="openai">OpenAI (Standard)</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="claude">Anthropic Claude</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none" data-i18n="timeout">Timeout (seconds)</label>
                        <input type="number" id="editTimeout" name="timeout" min="1" max="300"
                               class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none" data-i18n="upstream_url">Upstream URL</label>
                    <input type="url" id="editUpstreamUrl" name="upstream_url" required
                           class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none" data-i18n="model_name">Model Name</label>
                    <input type="text" id="editUpstreamModel" name="upstream_model" required
                           class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal('editModelModal')" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2" data-i18n="cancel">Cancel</button>
                    <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2" data-i18n="save">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Integration Modal -->
    <div id="integrationModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm hidden">
        <div class="bg-card text-card-foreground rounded-xl shadow-2xl w-full max-w-4xl mx-4 animate-in border flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-muted/20">
                <div class="flex items-center gap-2">
                    <div class="p-2 bg-purple-100 text-purple-600 rounded-md">
                        <i data-lucide="blocks" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-lg font-semibold tracking-tight" data-i18n="integration_guide">Integration Guide</h3>
                </div>
                <button onclick="closeModal('integrationModal')" class="rounded-md p-2 hover:bg-accent hover:text-accent-foreground transition">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto">
                <p class="text-muted-foreground mb-6 text-sm" data-i18n="integration_desc">
                    Connect any client to your models using Universal Protocol Translation.
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- OpenAI Card -->
                    <div class="border rounded-xl p-5 bg-card text-card-foreground shadow-sm hover:shadow-md transition-all relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <i data-lucide="bot" class="w-16 h-16 text-green-500"></i>
                        </div>
                        <h4 class="font-semibold text-green-600 mb-4 flex items-center gap-2">
                            OpenAI Compatible
                        </h4>
                        <div class="space-y-4 relative z-10">
                            <div>
                                <div class="flex justify-between items-center mb-1.5">
                                    <span class="text-[10px] text-muted-foreground font-semibold uppercase tracking-wider">Base URL</span>
                                    <button onclick="copyToClipboard(document.getElementById('baseOpenAIUrl').textContent, this)" class="text-muted-foreground hover:text-foreground"><i data-lucide="copy" class="w-3 h-3"></i></button>
                                </div>
                                <div class="bg-muted/50 border rounded-md p-2 text-[10px] font-mono text-foreground break-all" id="baseOpenAIUrl"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Claude Card -->
                    <div class="border rounded-xl p-5 bg-card text-card-foreground shadow-sm hover:shadow-md transition-all relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <i data-lucide="sparkles" class="w-16 h-16 text-purple-500"></i>
                        </div>
                        <h4 class="font-semibold text-purple-600 mb-4 flex items-center gap-2">
                            Anthropic Claude
                        </h4>
                        <div class="space-y-4 relative z-10">
                            <div>
                                <div class="flex justify-between items-center mb-1.5">
                                    <span class="text-[10px] text-muted-foreground font-semibold uppercase tracking-wider">Base URL</span>
                                    <button onclick="copyToClipboard(document.getElementById('baseClaudeUrl').textContent, this)" class="text-muted-foreground hover:text-foreground"><i data-lucide="copy" class="w-3 h-3"></i></button>
                                </div>
                                <div class="bg-muted/50 border rounded-md p-2 text-[10px] font-mono text-foreground break-all" id="baseClaudeUrl"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Gemini Card -->
                    <div class="border rounded-xl p-5 bg-card text-card-foreground shadow-sm hover:shadow-md transition-all relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <i data-lucide="gem" class="w-16 h-16 text-blue-500"></i>
                        </div>
                        <h4 class="font-semibold text-blue-600 mb-4 flex items-center gap-2">
                            Google Gemini
                        </h4>
                        <div class="space-y-4 relative z-10">
                            <div>
                                <div class="flex justify-between items-center mb-1.5">
                                    <span class="text-[10px] text-muted-foreground font-semibold uppercase tracking-wider">Base URL</span>
                                    <button onclick="copyToClipboard(document.getElementById('baseGeminiUrl').textContent, this)" class="text-muted-foreground hover:text-foreground"><i data-lucide="copy" class="w-3 h-3"></i></button>
                                </div>
                                <div class="bg-muted/50 border rounded-md p-2 text-[10px] font-mono text-foreground break-all" id="baseGeminiUrl"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 bg-amber-50/50 border border-amber-200 p-4 rounded-lg flex gap-3">
                    <i data-lucide="lightbulb" class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"></i>
                    <p class="text-sm text-amber-900" data-i18n="pro_tip">
                        <strong>Pro Tip:</strong> You can use ANY API Key created in "Add Key" for ANY of these protocols. 
                        The gateway automatically routes requests based on the model name you provide.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Improved Toast -->
    <div id="toast" class="fixed bottom-6 right-6 z-[100] hidden transition-all duration-300">
        <div class="bg-foreground text-background rounded-lg shadow-xl px-4 py-3 flex items-center gap-3 animate-in slide-in-from-right-5 fade-in zoom-in-95">
            <div id="toastIconContainer"></div>
            <p id="toastMessage" class="text-sm font-medium pr-2"></p>
        </div>
    </div>

    <script>
        // --- Translations ---
        const translations = {
            en: {
                connection_lost: "Connection lost. Is the server running?",
                retry: "Retry", welcome_back: "Welcome Back", enter_key: "Enter your admin API key to access the gateway.",
                access_dashboard: "Access Dashboard", no_key_hint: "Don't have a key? Check the server logs on startup.",
                app_title: "LLM Gateway", refresh: "Refresh", logs: "Logs", connect: "Connect", keys: "Keys", new_group: "New Group",
                total_groups: "Total Groups", total_models: "Total Models", active_keys: "Active Keys", total_requests: "Total Requests",
                syncing: "Syncing data...", request_logs: "Request Logs", logs_desc: "Recent API requests processed by the gateway.",
                loading_logs: "Loading logs...", no_logs: "No logs found.", th_time: "Time", th_status: "Status", th_latency: "Latency",
                th_model: "Model", th_ip: "IP", th_reqid: "ReqID", prev: "Previous", next: "Next", create_group: "Create Model Group",
                group_desc: "Groups allow you to load balance or failover between multiple models.", group_id: "Group ID",
                strategy: "Strategy", fallback: "Fallback (Failover)", round_robin: "Round Robin", cancel: "Cancel", create: "Create",
                add_model: "Add Model", model_desc: "Configure a new upstream model provider.", provider: "Provider",
                timeout: "Timeout (seconds)", upstream_url: "Upstream URL", model_name: "Model Name", api_keys: "API Keys (one per line)",
                add: "Add", add_key: "Add API Key", api_key: "API Key", admin_keys: "Admin Keys", admin_keys_desc: "Manage access keys for this dashboard.",
                generate_key: "Generate New Key", th_name: "Name", th_preview: "Key Preview", th_created: "Created", th_actions: "Actions",
                no_admin_keys: "No admin keys found.", new_admin_key: "New Admin Key", key_name: "Key Name",
                key_hint: "The key will only be shown once. Please save it securely.", key_generated: "Key Generated",
                save_key_msg: "Please save this key now. It won't be shown again!", saved_it: "I've Saved It", edit_model: "Edit Model",
                save: "Save Changes", integration_guide: "Integration Guide", integration_desc: "Connect any client to your models using Universal Protocol Translation.",
                pro_tip: "<strong>Pro Tip:</strong> You can use ANY API Key created in 'Add Key' for ANY of these protocols. The gateway automatically routes requests based on the model name you provide.",
                no_groups_title: "No Model Groups", no_groups_desc: "Create a group to start adding models and routing traffic.",
                create_first_group: "Create First Group", no_models_in_group: "No models in this group.", add_model_btn: "Add Model",
                logs_viewer: "Logs Viewer", request_history: "Request History", system_console: "System Console", reading_file: "Reading gateway.log..."
            },
            zh: {
                connection_lost: "",
                retry: "", welcome_back: "", enter_key: " API ",
                access_dashboard: "", no_key_hint: "",
                app_title: "LLM ", refresh: "", logs: "", connect: "", keys: "", new_group: "",
                total_groups: "", total_models: "", active_keys: "", total_requests: "",
                syncing: "...", request_logs: "", logs_desc: " API ",
                loading_logs: "...", no_logs: "", th_time: "", th_status: "", th_latency: "",
                th_model: "", th_ip: "IP", th_reqid: "ID", prev: "", next: "", create_group: "",
                group_desc: "", group_id: " ID", strategy: "",
                fallback: " (Fallback)", round_robin: " (Round Robin)", cancel: "", create: "",
                add_model: "", model_desc: "", provider: "", timeout: " ()",
                upstream_url: " URL", model_name: "", api_keys: "API  ()", add: "",
                add_key: " API ", api_key: "API ", admin_keys: "", admin_keys_desc: "",
                generate_key: "", th_name: "", th_preview: "", th_created: "", th_actions: "",
                no_admin_keys: "", new_admin_key: "", key_name: "",
                key_hint: "", key_generated: "",
                save_key_msg: "", saved_it: "", edit_model: "",
                save: "", integration_guide: "", integration_desc: "",
                pro_tip: "<strong></strong>  API ",
                no_groups_title: "", no_groups_desc: "",
                create_first_group: "", no_models_in_group: "", add_model_btn: "",
                logs_viewer: "", request_history: "", system_console: "", reading_file: " gateway.log..."
            }
        };

        // --- State ---
        let adminKey = localStorage.getItem('admin_key');
        let currentLang = localStorage.getItem('lang') || 'en';
        let dashboardData = [];
        let logsOffset = 0;
        let currentLogTab = 'request';
        const LOGS_LIMIT = 50;

        document.addEventListener('DOMContentLoaded', () => {
            renderIcons();
            updateLanguage(currentLang);
            if (adminKey) { document.getElementById('loginModal').classList.add('hidden'); loadDashboard(); } 
            else { showModal('loginModal'); }
            setupEventDelegation();
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('addGroupForm').addEventListener('submit', handleAddGroup);
            document.getElementById('addModelForm').addEventListener('submit', handleAddModel);
            document.getElementById('addKeyForm').addEventListener('submit', handleAddKey);
            document.getElementById('editModelForm').addEventListener('submit', handleEditModel);
            document.getElementById('addAdminKeyForm').addEventListener('submit', createAdminKey);
        });

        // --- I18n ---
        function toggleLanguage() { currentLang = currentLang === 'en' ? 'zh' : 'en'; localStorage.setItem('lang', currentLang); updateLanguage(currentLang); }
        function updateLanguage(lang) {
            document.getElementById('currentLang').textContent = lang.toUpperCase();
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.innerHTML = translations[lang][key];
            });
            if (dashboardData.length > 0) renderDashboard();
        }
        function t(key) { return translations[currentLang][key] || key; }

        // --- API ---
        async function fetchAPI(url, options = {}) {
            const token = localStorage.getItem('admin_key');
            const headers = new Headers({ 'Content-Type': 'application/json' });
            if (token) headers.append('Authorization', 'Bearer ' + token.trim());
            try {
                const resp = await fetch(url, { ...options, headers });
                const data = await resp.json();
                if (!resp.ok) {
                    if (resp.status === 401) { localStorage.removeItem('admin_key'); showModal('loginModal'); }
                    throw new Error(data?.error?.message || data?.message || "Request failed");
                }
                document.getElementById('networkErrorBanner').classList.add('hidden');
                return { resp, data };
            } catch (err) {
                if (err instanceof TypeError) document.getElementById('networkErrorBanner').classList.remove('hidden');
                throw err;
            }
        }

        // --- Render ---
        function renderDashboard() {
            const container = document.getElementById('groupsContainer');
            container.innerHTML = '';
            if (!dashboardData.length) {
                container.innerHTML = `<div class="text-center py-16 border-2 border-dashed rounded-xl bg-muted/20"><div class="w-16 h-16 bg-muted rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="layers" class="w-8 h-8 text-muted-foreground/50"></i></div><h3 class="text-xl font-semibold tracking-tight">${t('no_groups_title')}</h3><p class="text-muted-foreground text-sm mt-2 max-w-sm mx-auto">${t('no_groups_desc')}</p><button onclick="showAddGroupModal()" class="mt-6 inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-6 py-2 shadow-sm">${t('create_first_group')}</button></div>`;
                renderIcons(); return;
            }
            dashboardData.forEach(g => container.appendChild(createGroupCard(g)));
            renderIcons();
        }

        function createGroupCard(g) {
            const card = document.createElement('div');
            card.className = 'bg-card text-card-foreground rounded-xl border shadow-sm overflow-hidden transition-all hover:border-muted-foreground/30';
            const badge = g.strategy === 'round_robin' ? `<span class="px-2.5 py-1 text-xs font-semibold bg-emerald-500/10 text-emerald-600 rounded-md border border-emerald-500/20 inline-flex items-center gap-1.5"><i data-lucide="refresh-ccw" class="w-3 h-3"></i> ${t('round_robin')}</span>` : `<span class="px-2.5 py-1 text-xs font-semibold bg-blue-500/10 text-blue-600 rounded-md border border-blue-500/20 inline-flex items-center gap-1.5"><i data-lucide="arrow-down-narrow-wide" class="w-3 h-3"></i> ${t('fallback')}</span>`;
            const models = g.details?.models?.length ? g.details.models.map((m, i) => createModelRow(m, i, g.group_id)).join('') : `<div class="text-center py-12 text-muted-foreground text-sm italic bg-muted/5 border-b border-border">${t('no_models_in_group')}</div>`;
            card.innerHTML = `<div class="px-6 py-5 border-b bg-muted/10 flex items-center justify-between"><div><div class="flex items-center gap-3"><h2 class="text-lg font-bold tracking-tight">${g.group_id}</h2>${badge}</div><div class="text-xs text-muted-foreground mt-1.5 flex items-center gap-3 font-medium"><span><i data-lucide="box" class="w-3.5 h-3.5 mr-1 inline"></i>${g.model_count} models</span><span class="text-muted-foreground/30">|</span><span class="uppercase tracking-wider text-[10px]">ID: ${g.id}</span></div></div><div class="flex items-center gap-2"><button data-action="showAddModelModal" data-group-id="${g.group_id}" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-9 px-3 gap-2 border bg-background shadow-sm hover:bg-accent"><i data-lucide="plus" class="w-4 h-4"></i> ${t('add_model_btn')}</button><button data-action="deleteGroup" data-group-id="${g.group_id}" class="inline-flex items-center justify-center rounded-md h-9 w-9 text-muted-foreground hover:bg-destructive/10 hover:text-destructive transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div><div class="divide-y divide-border/50">${models}</div>`;
            return card;
        }

        function createModelRow(m, i, gid) {
            const keys = m.api_keys?.length ? m.api_keys.map(k => createKeyElement(k)).join('') : `<span class="text-xs text-muted-foreground italic pl-1">No API keys</span>`;
            let icon = 'box', color = 'text-muted-foreground';
            if (m.provider_name === 'openai') { icon = 'bot'; color = 'text-green-600'; }
            else if (m.provider_name === 'claude') { icon = 'sparkles'; color = 'text-purple-600'; }
            else if (m.provider_name === 'gemini') { icon = 'gem'; color = 'text-blue-600'; }
            return `<div class="p-4 hover:bg-muted/5 transition group"><div class="flex items-start gap-4 w-full"><div class="flex-shrink-0 mt-1"><span class="flex items-center justify-center w-6 h-6 rounded bg-muted text-xs font-mono text-muted-foreground font-medium">${i+1}</span></div><div class="flex-1 min-w-0"><div class="flex items-center gap-2 mb-1"><i data-lucide="${icon}" class="w-4 h-4 ${color}"></i><span class="font-semibold text-sm capitalize">${m.provider_name}</span><i data-lucide="arrow-right" class="w-3 h-3 text-muted-foreground/50"></i><span class="font-medium text-sm text-foreground">${m.upstream_model}</span><div class="ml-auto flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button data-action="editModel" data-id="${m.ID}" data-provider="${m.provider_name}" data-url="${m.upstream_url}" data-model="${m.upstream_model}" data-timeout="${m.timeout}" class="inline-flex items-center justify-center rounded-md h-8 w-8 text-muted-foreground hover:bg-accent hover:text-foreground"><i data-lucide="settings-2" class="w-4 h-4"></i></button><button data-action="deleteModel" data-id="${m.ID}" class="inline-flex items-center justify-center rounded-md h-8 w-8 text-muted-foreground hover:bg-destructive/10 hover:text-destructive"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div><div class="text-xs text-muted-foreground font-mono break-all bg-muted/30 px-2 py-0.5 rounded inline-block">${m.upstream_url}</div><div class="mt-3 flex flex-wrap gap-2 items-center">${keys}<button data-action="showAddKeyModal" data-id="${m.ID}" class="inline-flex items-center justify-center rounded-full border border-dashed px-2.5 py-0.5 text-xs font-medium text-muted-foreground hover:bg-accent h-6"><i data-lucide="plus" class="w-3 h-3 mr-1"></i> Key</button></div></div></div></div>`;
        }

        function createKeyElement(k) {
            return `<div class="inline-flex items-center gap-1.5 bg-background border rounded-md px-2 py-0.5 text-xs font-mono group/key relative pr-7 shadow-sm"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span><span class="cursor-pointer hover:text-primary transition-colors select-all" data-action="copyKey" data-key="${k.key_value}">${maskApiKey(k.key_value)}</span><button data-action="deleteKey" data-id="${k.ID}" class="absolute right-1 top-1/2 -translate-y-1/2 text-muted-foreground/50 hover:text-destructive p-0.5 rounded-sm hover:bg-destructive/10 hidden group-hover/key:block"><i data-lucide="x" class="w-3 h-3"></i></button></div>`;
        }

        function maskApiKey(k) { return k && k.length > 8 ? k.substring(0, 4) + '' + k.substring(k.length - 4) : k; }

        function updateStats() {
            let groups = dashboardData.length, models = 0, keys = 0, reqs = 0;
            dashboardData.forEach(g => {
                models += g.model_count;
                g.details?.models?.forEach(m => { keys += m.api_keys?.length || 0; reqs += m.total_requests || 0; });
            });
            document.getElementById('totalGroups').textContent = groups;
            document.getElementById('totalModels').textContent = models;
            document.getElementById('totalKeys').textContent = keys;
            document.getElementById('totalRequests').textContent = reqs;
        }

        // --- Logs Logic ---
        function switchLogTab(tab) {
            currentLogTab = tab;
            const isReq = tab === 'request';
            document.getElementById('tabRequestLogs').className = `px-4 py-3 text-sm font-medium border-b-2 transition-all ${isReq ? 'border-primary text-primary' : 'border-transparent text-muted-foreground hover:text-foreground'}`;
            document.getElementById('tabSystemLogs').className = `px-4 py-3 text-sm font-medium border-b-2 transition-all ${!isReq ? 'border-primary text-primary' : 'border-transparent text-muted-foreground hover:text-foreground'}`;
            document.getElementById('requestLogsContent').classList.toggle('hidden', !isReq);
            document.getElementById('systemLogsContent').classList.toggle('hidden', isReq);
            refreshCurrentLogs();
        }

        function refreshCurrentLogs() { currentLogTab === 'request' ? loadLogs(0) : loadSystemLogs(); }

        function showLogsModal() { switchLogTab('request'); showModal('logsModal'); }

        async function loadLogs(offset) {
            const list = document.getElementById('logsList'), loading = document.getElementById('logsLoading'), empty = document.getElementById('logsEmpty');
            list.innerHTML = ''; loading.classList.remove('hidden'); empty.classList.add('hidden');
            try {
                const { data } = await fetchAPI(`/admin/logs?limit=${LOGS_LIMIT}&offset=${offset}`);
                const logs = data.data.logs || [], total = data.data.total || 0;
                loading.classList.add('hidden');
                if (!logs.length) empty.classList.remove('hidden');
                else { logs.forEach(l => list.innerHTML += createLogRow(l)); renderIcons(); }
                logsOffset = offset;
                document.getElementById('logsPrevBtn').disabled = offset <= 0;
                document.getElementById('logsNextBtn').disabled = (offset + LOGS_LIMIT) >= total;
                document.getElementById('logsPaginationInfo').textContent = `Showing ${total ? offset + 1 : 0}-${Math.min(offset + LOGS_LIMIT, total)} of ${total}`;
            } catch (e) { loading.classList.add('hidden'); }
        }

        async function loadSystemLogs() {
            const term = document.getElementById('systemLogsTerminal');
            try {
                const { data } = await fetchAPI('/admin/system-logs');
                const logs = data.data.logs || 'No logs found.';
                // Basic coloring for common log patterns
                term.innerHTML = logs.split('\n').map(line => {
                    if (line.includes("\"level\":\"error\"")) return `<span class=\"text-red-400\">${line}</span>`;
                    if (line.includes("\"level\":\"warn\"")) return `<span class=\"text-yellow-400\">${line}</span>`;
                    if (line.includes("\"level\":\"info\"")) return `<span class=\"text-blue-400\">${line}</span>`;
                    return line;
                }).join('\n');
                term.scrollTop = term.scrollHeight;
            } catch (e) { term.textContent = 'Error loading gateway.log'; }
        }

        function prevLogs() { if (logsOffset > 0) loadLogs(logsOffset - LOGS_LIMIT); }
        function nextLogs() { loadLogs(logsOffset + LOGS_LIMIT); }
        function createLogRow(l) {
            const date = new Date(l.created_at * 1000);
            let sc = 'text-green-600 bg-green-500/10 border-green-500/20';
            if (l.status_code >= 400) sc = 'text-yellow-600 bg-yellow-500/10 border-yellow-500/20';
            if (l.status_code >= 500) sc = 'text-red-600 bg-red-500/10 border-red-500/20';
            return `<tr class="hover:bg-muted/30 transition-colors"><td class="px-4 py-3 text-xs font-mono text-muted-foreground whitespace-nowrap">${date.toLocaleTimeString()}</td><td class="px-4 py-3"><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border ${sc}">${l.status_code}</span></td><td class="px-4 py-3 text-xs font-mono">${l.duration_ms}ms</td><td class="px-4 py-3 text-xs font-medium">${l.upstream_model || '-'}</td><td class="px-4 py-3 text-xs font-mono text-muted-foreground">${l.client_ip || '-'}</td><td class="px-4 py-3 text-xs font-mono text-muted-foreground truncate max-w-[100px]" title="${l.request_id}">${l.request_id}</td></tr>`;
        }

        // --- Interaction ---
        function setupEventDelegation() {
            document.addEventListener('click', e => {
                const t = e.target.closest('[data-action]'); if (!t) return; e.preventDefault();
                const a = t.getAttribute('data-action'), id = t.getAttribute('data-id'), gid = t.getAttribute('data-group-id'), key = t.getAttribute('data-key');
                switch (a) {
                    case 'showAddModelModal': showAddModelModal(gid); break;
                    case 'deleteGroup': deleteGroup(gid); break;
                    case 'editModel': editModel(id, t.dataset.provider, t.dataset.url, t.dataset.model, t.dataset.timeout); break;
                    case 'deleteModel': deleteModel(id); break;
                    case 'showAddKeyModal': showAddKeyModal(id); break;
                    case 'copyKey': copyToClipboard(key, t); break;
                    case 'deleteKey': deleteKey(id); break;
                    case 'deleteAdminKey': deleteAdminKey(id); break;
                }
            });
        }

        function showModal(mid) { forceCloseAllModals(); const m = document.getElementById(mid); if (m) { m.classList.remove('hidden'); m.classList.add('flex'); } }
        function closeModal(mid) { const m = document.getElementById(mid); if (m) { m.classList.add('hidden'); m.classList.remove('flex'); const f = m.querySelector('form'); if (f) f.reset(); } }
        function forceCloseAllModals() { document.querySelectorAll('[id$="Modal"]').forEach(m => { m.classList.add('hidden'); m.classList.remove('flex'); }); }

        // --- CRUD Handlers ---
        async function handleLogin(e) {
            e.preventDefault(); const key = document.getElementById('adminKeyInput').value.trim();
            const btn = e.target.querySelector('button[type="submit"]');
            if (!key) return showToast('Please enter key', 'error');
            localStorage.setItem('admin_key', key.replace(/[^a-zA-Z0-9\-_]/g, ''));
            btn.disabled = true; btn.innerHTML = '<i data-lucide="loader-2" class="w-4 animate-spin mr-2"></i> ...'; renderIcons();
            try { await fetchAPI('/admin/model-groups'); closeModal('loginModal'); loadDashboard(); } 
            catch (err) { showToast(err.message, 'error'); localStorage.removeItem('admin_key'); } 
            finally { btn.disabled = false; btn.innerHTML = t('access_dashboard'); }
        }

        function logout() { localStorage.removeItem('admin_key'); location.reload(); }

        async function loadDashboard() {
            const loader = document.getElementById('loadingIndicator'), btn = document.getElementById('refreshBtn');
            if (!document.getElementById('groupsContainer').children.length) loader.classList.remove('hidden');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i>'; renderIcons(); }
            try {
                const { data } = await fetchAPI('/admin/model-groups'); dashboardData = data.data || [];
                for (let g of dashboardData) { const res = await fetchAPI('/admin/model-groups/' + encodeURIComponent(g.group_id)); g.details = res.data.data; }
                renderDashboard(); updateStats();
            } catch (err) { if (!err.message.includes("Session")) showToast('Load error', 'error'); } 
            finally { loader.classList.add('hidden'); if (btn) { btn.disabled = false; btn.innerHTML = `<i data-lucide="refresh-cw" class="w-4 h-4"></i> <span class="hidden sm:inline">${t('refresh')}</span>`; renderIcons(); } }
        }

        async function handleAddGroup(e) { e.preventDefault(); const fd = new FormData(e.target); try { await fetchAPI('/admin/model-groups', { method: 'POST', body: JSON.stringify({ group_id: fd.get('group_id'), strategy: fd.get('strategy') }) }); showToast('Group created', 'success'); closeModal('addGroupModal'); loadDashboard(); } catch (err) { showToast(err.message, 'error'); } }
        async function handleAddModel(e) { e.preventDefault(); const fd = new FormData(e.target); try { await fetchAPI(`/admin/model-groups/${fd.get('group_id')}/models`, { method: 'POST', body: JSON.stringify({ provider_name: fd.get('provider_name'), upstream_url: fd.get('upstream_url'), upstream_model: fd.get('upstream_model'), timeout: parseInt(fd.get('timeout')), keys: fd.get('keys').trim().split('\n').filter(k => k.trim()) }) }); showToast('Model added', 'success'); closeModal('addModelModal'); loadDashboard(); } catch (err) { showToast(err.message, 'error'); } }
        async function handleAddKey(e) { e.preventDefault(); const fd = new FormData(e.target); try { await fetchAPI(`/admin/models/${fd.get('model_id')}/keys`, { method: 'POST', body: JSON.stringify({ key: fd.get('key') }) }); showToast('Key added', 'success'); closeModal('addKeyModal'); loadDashboard(); } catch (err) { showToast(err.message, 'error'); } }
        async function handleEditModel(e) { e.preventDefault(); const fd = new FormData(e.target); try { await fetchAPI(`/admin/models/${fd.get('id')}`, { method: 'PUT', body: JSON.stringify({ provider_name: fd.get('provider_name'), upstream_url: fd.get('upstream_url'), upstream_model: fd.get('upstream_model'), timeout: parseInt(fd.get('timeout')) }) }); showToast('Model updated', 'success'); closeModal('editModelModal'); loadDashboard(); } catch (err) { showToast(err.message, 'error'); } }
        async function deleteGroup(id) { if (confirm(t('delete_group_confirm') || 'Delete group?')) try { await fetchAPI(`/admin/model-groups/${id}`, { method: 'DELETE' }); showToast('Deleted', 'success'); loadDashboard(); } catch (err) { showToast(err.message, 'error'); } }
        async function deleteModel(id) { if (confirm('Delete model?')) try { await fetchAPI(`/admin/models/${id}`, { method: 'DELETE' }); showToast('Deleted', 'success'); loadDashboard(); } catch (err) { showToast(err.message, 'error'); } }
        async function deleteKey(id) { if (confirm('Delete key?')) try { await fetchAPI(`/admin/keys/${id}`, { method: 'DELETE' }); showToast('Deleted', 'success'); loadDashboard(); } catch (err) { showToast(err.message, 'error'); } }

        function showAdminKeysModal() { loadAdminKeys(); showModal('adminKeysModal'); }
        async function loadAdminKeys() {
            try {
                const { data } = await fetchAPI('/admin/admin-keys'); const keys = data.data || [], list = document.getElementById('adminKeysList'), empty = document.getElementById('noAdminKeys');
                list.innerHTML = ''; empty.classList.toggle('hidden', !!keys.length);
                list.innerHTML = keys.map((k, i) => `<tr class="hover:bg-muted/30"><td class="px-4 py-3 font-medium">${i+1}</td><td class="px-4 py-3 font-medium">${k.name}</td><td class="px-4 py-3 font-mono text-xs text-muted-foreground" title="${k.key}">${k.key_preview || maskApiKey(k.key)}</td><td class="px-4 py-3 text-muted-foreground text-xs">${new Date(k.created_at * 1000).toLocaleDateString()}</td><td class="px-4 py-3 flex gap-2"><button onclick="copyToClipboard('${k.key}', this)" class="p-1 hover:text-primary rounded"><i data-lucide="copy" class="w-4 h-4"></i></button><button data-action="deleteAdminKey" data-id="${k.id}" class="p-1 hover:text-destructive rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('');
                renderIcons();
            } catch (e) { showToast('Load error', 'error'); }
        }
        async function createAdminKey(e) { e.preventDefault(); const n = new FormData(e.target).get('name'); try { const { data } = await fetchAPI('/admin/admin-keys', { method: 'POST', body: JSON.stringify({ name: n }) }); document.getElementById('newAdminKeyValue').value = data.data.key; closeModal('addAdminKeyModal'); showModal('newAdminKeyModal'); } catch (err) { showToast('Failed', 'error'); } }
        async function deleteAdminKey(id) { if (confirm('Delete admin key?')) try { await fetchAPI(`/admin/admin-keys/${id}`, { method: 'DELETE' }); showToast('Deleted', 'success'); loadAdminKeys(); } catch (err) { showToast(err.message, 'error'); } }

        // --- Helpers ---
        function showIntegrationModal() { const o = window.location.origin; document.getElementById('baseOpenAIUrl').textContent = o + '/v1'; document.getElementById('baseClaudeUrl').textContent = o + '/v1'; document.getElementById('baseGeminiUrl').textContent = o; showModal('integrationModal'); }
        function showAddGroupModal() { showModal('addGroupModal'); }
        function showAddModelModal(gid) { document.getElementById('addModelGroupId').value = gid; showModal('addModelModal'); }
        function showAddKeyModal(mid) { document.getElementById('addKeyModelId').value = mid; showModal('addKeyModal'); }
        function showAddAdminKeyModal() { showModal('addAdminKeyModal'); }
        function editModel(id, p, u, m, t) { document.getElementById('editModelId').value = id; document.getElementById('editProviderName').value = p; document.getElementById('editUpstreamUrl').value = u; document.getElementById('editUpstreamModel').value = m; document.getElementById('editTimeout').value = t; showModal('editModelModal'); }
        function copyToClipboard(t, e) { if (navigator.clipboard) navigator.clipboard.writeText(t).then(() => showCopySuccess(e)).catch(() => fallbackCopy(t, e)); else fallbackCopy(t, e); }
        function fallbackCopy(t, e) { const ta = document.createElement('textarea'); ta.value = t; ta.style.position = 'fixed'; ta.style.left = '-9999px'; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); showCopySuccess(e); } catch (e) {} document.body.removeChild(ta); }
        function showCopySuccess(e) { const i = e.querySelector('svg') || e.querySelector('i'); if (i) { const oc = i.style.color; i.style.color = '#22c55e'; setTimeout(() => i.style.color = oc, 2000); } showToast('Copied', 'success'); }
        function showToast(m, t) { const toast = document.getElementById('toast'), msg = document.getElementById('toastMessage'), ic = document.getElementById('toastIconContainer'); msg.textContent = m; ic.innerHTML = t === 'success' ? '<i data-lucide="check-circle-2" class="w-5 h-5 text-green-500"></i>' : '<i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>'; renderIcons(); toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('hidden'), 3000); }
        function refreshDashboard() { loadDashboard(); }
    </script>
</body>
</html>